# API Gateway Configuration for Production Environment

server:
  port: 8080

spring:
  cloud:
    gateway:
      server:
        webflux:
          # Global CORS configuration for production
          globalcors:
            cors-configurations:
              '[/**]':
                allowedOrigins:
                  - "https://app.chargeroute.com"     # Production web app
                  - "https://admin.chargeroute.com"   # Production admin dashboard
                allowedMethods:
                  - GET
                  - POST
                  - PUT
                  - DELETE
                  - OPTIONS
                allowedHeaders: "*"
                allowCredentials: true
                maxAge: 3600

          # Default filters for production
          default-filters:
            - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials
            - AddRequestHeader=X-Gateway-Name, ChargeRoute-API-Gateway
            - AddRequestHeader=X-Request-Timestamp, #{T(java.time.Instant).now().toString()}
            - AddRequestHeader=X-Environment, production

          # Enable automatic route discovery from Eureka
          discovery:
            locator:
              enabled: true
              lower-case-service-id: true

          # Custom route definitions with production resilience
          routes:
            # User Management Service Routes
            - id: user-service-route
              uri: lb://user-management-service
              predicates:
                - Path=/api/users/**
              filters:
                - name: CircuitBreaker
                  args:
                    name: user-service-cb
                    fallbackUri: forward:/fallback/users
                - name: Retry
                  args:
                    retries: 3
                    statuses: BAD_GATEWAY,GATEWAY_TIMEOUT
                    backoff:
                      firstBackoff: 50ms
                      maxBackoff: 500ms
                - AddRequestHeader=X-Service-Route, user-management

            # Charge Unit Management Service Routes  
            - id: charge-unit-service-route
              uri: lb://charge-unit-management-service
              predicates:
                - Path=/api/charge-units/**
              filters:
                - name: CircuitBreaker
                  args:
                    name: charge-unit-service-cb
                    fallbackUri: forward:/fallback/charge-units
                - name: Retry
                  args:
                    retries: 3
                    statuses: BAD_GATEWAY,GATEWAY_TIMEOUT
                - AddRequestHeader=X-Service-Route, charge-unit-management

            # Session Management Service Routes
            - id: session-service-route
              uri: lb://session-management-service
              predicates:
                - Path=/api/sessions/**
              filters:
                - name: CircuitBreaker
                  args:
                    name: session-service-cb
                    fallbackUri: forward:/fallback/sessions
                - name: Retry
                  args:
                    retries: 3
                    statuses: BAD_GATEWAY,GATEWAY_TIMEOUT
                - AddRequestHeader=X-Service-Route, session-management

            # Notification Management Service Routes
            - id: notification-service-route
              uri: lb://notification-management-service
              predicates:
                - Path=/api/notifications/**
              filters:
                - name: CircuitBreaker
                  args:
                    name: notification-service-cb
                    fallbackUri: forward:/fallback/notifications
                - AddRequestHeader=X-Service-Route, notification-management

            # Gateway actuator endpoints
            - id: gateway-actuator-route
              uri: http://localhost:8080
              predicates:
                - Path=/actuator/**
              filters:
                - AddRequestHeader=X-Internal-Request, gateway-actuator

          # Production HTTP client settings
          httpclient:
            connect-timeout: 5000
            response-timeout: 10s

    # Production circuit breaker settings
    circuitbreaker:
      resilience4j:
        configs:
          default:
            failure-rate-threshold: 50
            wait-duration-in-open-state: 30s
            sliding-window-size: 10
            minimum-number-of-calls: 5
  

# Eureka Client Configuration
eureka:
  client:
    service-url:
      defaultZone: http://chargeroute:Admin123!@localhost:8761/eureka/
    fetch-registry: true
    register-with-eureka: true
    registry-fetch-interval-seconds: 30
  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${spring.application.instance_id:${random.value}}
    # Production - standard heartbeat
    lease-renewal-interval-in-seconds: 30
    lease-expiration-duration-in-seconds: 90
    metadata-map:
      zone: production
      version: 1.0.0
      type: api-gateway

# Production logging - restricted
logging:
  level:
    org.springframework.cloud.gateway: INFO
    com.chargeroute.gateway: INFO
    reactor.netty.http.client: WARN
    root: WARN